# Changelog

## [1.6.11] - 2025-03-21

### 수정됨
- 대기전력차단스위치 cutoff 범위 관련 에러 수정
### 추가됨
- 대기전력용 scailing factor 도입 (ecomode_scailing_factor), 기본값 1
- 기존 scailing_factor는 wattage_scailing_factor로 이름이 변경되었으며 0.1이 아닌 값을 사용중이신 분들은 다시 수정하셔야합니다.

## [1.6.10] - 2025-03-20

### 수정됨
- 대기전력차단스위치 cutoff 범위 관련 에러 수정

## [1.6.9] - 2025-03-18

### 수정됨
- ew11 재부팅 실패에도 재부팅 카운트가 초기화되어 unavailable발동이 안되던 문제 수정

## [1.6.8] - 2025-03-06

### 수정됨
- 보일러의 action_topic이 작동하지 않던 문제 해결 (난방 중, 유휴 중 표시)

## [1.6.7] - 2025-01-25

### 수정됨
- 콘센트 대기전력차단 디스커버리 설정이 잘못되어있어 패킷을 잘 못 만들던 문제 수정됨.
  - 이 수정으로 인해 자동대기전력차단이 중복으로 생길수 있는데, mqtt에등록된 commax_wallpad 기기를 삭제 후 애드온을 재시작하면 정상등록됩니다.

### 주의
- 업데이트 후 엔티티아이디가 변경될 수 있습니다 불편을 드려 죄송합니다 ㅠㅠ

## [1.6.6] - 2025-01-24

### 추가됨
- 콘센트에 자동대기전력차단 값 설정 기능 추가. (HA카페 미스틱525님 감사합니다)
- 콘센트 관련 패킷구조 변경이 있었습니다. (기존 auto -> ecomode, _auto -> _eco) 
  - ※ 커스텀패킷구조를 사용중인 경우 커스텀 패킷 초기화를 한번 수행해야 할 것 같습니다.
  - 직접 수정을 원하는 경우 설정에서 ```vender```를 ```commax```로 설정후 패킷참조자료를 확인하여 커스텀패킷구조의 이름들을 똑같이 수정해도 됩니다.

### 수정됨
- 로거클래스에서 발생할 수 있었던 핸들러 오류 수정


## [1.6.5] - 2025-01-23

### 개선됨
- 콘센트에 자동대기전력차단모드 센서를 스위치로 변경, 켜고 끄기 가능합니다. (HA카페 미스틱525님 감사합니다)
  - ※ 커스텀패킷구조를 이미 사용중인 경우 커스텀 패킷 초기화를 한번 수행해야 적용됩니다.
  - 또는 패킷편집 - Outlet - command의 position2(commandType)에 ```"auto": "02"```를 추가해주시면 적용됩니다.
- 기존의 자동대기전력차단모드 센서가 남아있는게 싫으신 경우 commax_wallpad 기기 제거 후 애드온 재시작을 해주세요.

## [1.6.4] - 2025-01-21

### 추가됨
- 콘센트에 자동대기전력차단모드 센서 추가됨.
- 콘센트 전력량 scailing factor 설정 추가(측정된 전력량에 scailing factor를 곱하여 표시합니다. 기본값: 0.1). - 커스텀패킷수정탭에서 수정 가능 
  - ※ 커스텀패킷구조를 이미 사용중인 경우 커스텀 패킷 초기화를 한번 수행해야 적용됩니다. 또는 ```/share/packet_structures_custom.yaml```에서 Outlet - state - header와 같은 레벨로 ```scailing_factor: 0.1```을 한줄 추가후 저장해도됩니다.
- 가스밸브 상태 업데이트 메서드 누락된 부분 추가함.

## [1.6.3] - 2025-01-15

### 수정됨
- 콘센트 상태업데이트 인덱스 오류 수정

## [1.6.2] - 2025-01-10

### 개선됨
- EW11 응답 없을 때 HA 알림생성 - 기본값 20분으로 변경
  - 저희집 EW11은 한번 응답없으면 7분정도 후에 다시 응답오더라구요.. elfin_reboot_interval 값을 조절하면 HA알림 주기를 늦추거나 앞당길 수 있습니다. (대략 elfin_reboot_interval x 20회 (초))
  - elfin_unavailable_notification 설정으로 on/off 시킬 수 있습니다.
- EW11 응답 없을 때 구성요소 사용 불가 표시
  - HA에 availablity topic을 통해 EW11 응답이 없을 때(자동 재부팅 트리거될 때) 구성요소들 사용불가 표시합니다.
  - 자동화에 사용할 수 있을 듯 합니다. (예를들어, `Light1이 사용 불가가 되었을 때 -> EW11전원플러그 껏다가 1초후 다시 켜기`와 같은 자동화를 설정하면 EW11이 응답할때까지 7분가량 기다리지 않고 바로 복구될것으로 예상됨.)
- 월패드 휴식 상태일때 명령 전송 기능 옵션화
  - 월패드가 패킷전송을 잠시 쉴 때 (>130ms, 저희집은 700ms정도..) 애드온에서 생성한 명령패킷을 전송하는 기능을 옵션화했습니다.
  - send_command_on_idle 옵션을 True로 해두면 월패드가 쉴때 명령을 전송하므로 월패드 부담을 줄여줄 것 같습니다. (그냥 예상입니다.)
  - false로 꺼두면 즉시 명령패킷을 전송하므로 보다 빠른 응답을 기대할 수 있을 것 같습니다. 다만 max_send_count를 기본값보다 높여야 씹힐 확률이 낮아집니다. (30 정도)
  - 실제로 응답속도가 빨라졌냐면 그건 잘 모르겠습니다..

### 수정됨
- 연속으로 이전 상태로 돌아가는 명령패킷이 들어왔을 때 이전 상태 패킷이 남아있어 명령 재전송이 조기종료되는 현상 수정.
  - 예: 온도변경 19 -> 20 -> 19에서 recv_data에 19도일때 상태패킷 남아있어 20->19 명령의 예상 상태패킷이 아직 안왔음에도 성공으로 판단하여 재전송 중지되었으나 수정함.
- 가스밸브잠금, EV호출 버튼 오류 수정
- 콘센트 전력량, 가스밸브상태, EV 층수 센서가 누락되어있어 추가하였습니다.

## [1.6.1] - 2025-01-07

### 주의
⚠️ 이 버전은 설정 구조가 변경되었습니다. 업데이트 후 설정을 다시 확인해주세요.
    - mqtt 설정은 HA에 애드온으로 mqttbroker를 사용중인경우 변경할 필요가 없습니다.
    - elfin 설정은 자동재시작 기능을 사용하지 않는경우 필요가 없습니다.

### 추가됨
- 기본 mqtt 서버를 사용하도록 변경.
  - 더이상 서버주소, 아이디, 패스워드를 설정할 필요가 없습니다.
- 애드온 설정 변경
  - 관련설정별 하위설정으로 묶었습니다.

### 개선됨
- EW11 응답 없을 때 재시작으로 해결 안되면 HA 알림 생성
- 웹UI 개선
  - 다크모드추가
  - 기능오류 수정

## [1.6.0] - 2025-01-04

### 개선됨
- 누락되었던 제어기능 추가 - 조명차단기, 콘센트, 가스밸브, 엘리베이터
- 테스트코드 추가
- 모듈 구조 및 파일 처리 개선
  - Dockerfile 업데이트
    - PYTHONPATH 설정 추가
    - 모듈 문법을 사용한 명령 실행 방식으로 변경
  - 코드 구조 개선
    - main.py의 상대 임포트 적용
    - WallpadController의 커스텀 패킷 파일 경로 처리 개선
    - YAML 파일 인코딩 처리 강화
  - EV 명령 구조 업데이트
    - 헤더 충돌 방지
    - 주석 명확성 개선
  - config.json 설정 설명 개선

## [1.5.14] - 2025-01-04

### 개선됨
- 패킷 구조 및 기기 제어 기능 강화
  - Outlet 전력량 처리 로직 개선
  - 커스텀 패킷 구조 관리 기능 강화
    - UI에 초기화 버튼 추가
- Dockerfile 의존성 정리
